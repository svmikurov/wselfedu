"""Migration to create Exercise table with PostgreSQL table inheritance.

Creates:
1. Table `lang.exercise` that inherits from `core.exercise`
2. Automatic ID generation using PostgreSQL identity column

Important notes:
- Inherits all columns from parent table `core.exercise`
- Child table can add additional columns specific to language exercises
- CASCADE used in reverse migration to ensure proper cleanup
"""

from django.db import migrations

# SQL for creating the inherited table
CREATE_TABLE_SQL = """
CREATE TABLE lang.exercise (
    id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY
) INHERITS (core.exercise);
ALTER TABLE lang.exercise
ALTER COLUMN created_at SET DEFAULT CURRENT_TIMESTAMP,
ALTER COLUMN updated_at SET DEFAULT CURRENT_TIMESTAMP;
"""

# SQL for reverse migration
DROP_TABLE_SQL = """
DROP TABLE IF EXISTS lang.exercise CASCADE;
"""


class Migration(migrations.Migration):
    """Migration to create language exercise table with inheritance."""

    dependencies = [
        ('contenttypes', '0001_initial'),  # Required for Django's content types
        ('core', '0001_create_base_exercise'),  # Parent table must exist
    ]

    operations = [
        migrations.RunSQL(
            sql=CREATE_TABLE_SQL,
            reverse_sql=DROP_TABLE_SQL,
        ),
    ]
